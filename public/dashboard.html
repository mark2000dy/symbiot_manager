<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard - Sistema de Gastos Symbiot</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#191C24">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #000 0%, #191C24 50%, #000 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
        }
        
        .navbar {
            background: rgba(25, 28, 36, 0.95) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .navbar-brand {
            color: #EB1616 !important;
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .navbar-nav .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            transition: color 0.3s ease;
        }
        
        .navbar-nav .nav-link:hover {
            color: #EB1616 !important;
        }
        
        .main-content {
            padding: 2rem 0;
        }

        .text-muted, .small, .stat-label {
            color: #E4E6EA !important; /* Gris mucho más claro */
        }
        
        .stat-card {
            background: rgba(25, 28, 36, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .stat-icon {
            font-size: 2.5rem;
        }
        
        /* 🎨 MEJORA: Textos más claros para mejor visibilidad */
        .stat-card .card-title {
            color: #B0B3B8 !important; /* Gris más claro */
            font-weight: 500;
        }
        
        .stat-card h4 {
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .card {
            background: rgba(25, 28, 36, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .card-header {
            background: rgba(235, 22, 22, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .table-dark {
            background: transparent;
        }
        
        .table-dark tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #EB1616, #FF4444);
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(45deg, #FF4444, #EB1616);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(235, 22, 22, 0.4);
        }
        
        .btn-outline-primary {
            border-color: #EB1616;
            color: #EB1616;
        }
        
        .btn-outline-primary:hover {
            background-color: #EB1616;
            border-color: #EB1616;
        }
        
        .badge-success {
            background-color: #28a745 !important;
        }
        
        .badge-danger {
            background-color: #dc3545 !important;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .welcome-banner {
            background: linear-gradient(135deg, rgba(235, 22, 22, 0.2), rgba(255, 68, 68, 0.1));
            border: 1px solid rgba(235, 22, 22, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        /* 🎨 MEJORA: Texto empresa y fecha más visible */
        .welcome-banner .text-muted {
            color: #B0B3B8 !important; /* Gris más claro */
            opacity: 0.9;
        }
        
        .transaction-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .transaction-row:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .alert {
            border: none;
            border-radius: 10px;
        }
        
        /* 🎨 Modal personalizado */
        .modal-content {
            background: rgba(25, 28, 36, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
        }
        
        .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-control {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .form-control:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #EB1616;
            box-shadow: 0 0 0 0.2rem rgba(235, 22, 22, 0.25);
            color: white;
        }
        
        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .form-label {
            color: #B0B3B8;
            font-weight: 500;
        }
        
        .form-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .form-select option {
            background: #191C24;
            color: white;
        }
        
        .form-select:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: #EB1616;
            color: white;
        }

        /* Dropdown menu styling */
        .dropdown-menu {
            background: rgba(25, 28, 36, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .dropdown-item {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .dropdown-item:hover {
            background-color: rgba(235, 22, 22, 0.2);
            color: white;
        }

        /* Fix para btn-close en modal */
        .btn-close-white {
            background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23ffffff'%3e%3cpath d='m.235.227 7.618 7.554L15.47.226a.75.75 0 1 1 1.06 1.06L8.912 8.84l7.618 7.618a.75.75 0 1 1-1.061 1.06L7.85 9.901.232 17.52a.75.75 0 0 1-1.061-1.06L6.789 8.84.17 1.286A.75.75 0 1 1 1.231.227z'/%3e%3c/svg%3e") center/1em auto no-repeat;
        }
        .company-stats .stat-item {
            padding: 0.5rem;
        }

        .company-stats .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .company-stats .stat-label {
            font-size: 0.85rem;
            color: #E4E6EA;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .student-stat h4 {
            font-size: 2rem;
            font-weight: 700;
        }

        .alert-warning {
            background-color: rgba(255, 193, 7, 0.1);
            border-color: rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }

        .alert-danger {
            background-color: rgba(220, 53, 69, 0.1);
            border-color: rgba(220, 53, 69, 0.3);
            color: #dc3545;
        }

        .alert-heading {
            color: inherit;
            font-size: 1rem;
            font-weight: 600;
        }

        #rockstarSkullWidgets .card {
            transition: all 0.3s ease;
        }

        #rockstarSkullWidgets .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .company-stats .stat-label {
            color: #E4E6EA !important;
        }

        #teachersOverview .text-muted {
            color: #B8B9BA !important;
        }

        #rockstarSkullWidgets .card-body small {
            color: #E4E6EA !important;
        }

        /* 🎯 Interactividad para números de alumnos */
        .student-stat:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .instrument-card {
            transition: all 0.3s ease;
        }

        .instrument-card:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.1) !important;
        }

        /* Mejorar indicadores del selector */
        .stat-item {
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-2px);
        }

        .student-row {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .student-row:hover {
            background-color: rgba(255, 255, 255, 0.08) !important;
        }

        .table-sm td {
            padding: 0.4rem;
            font-size: 0.85rem;
        }

        .table-sm th {
            padding: 0.5rem 0.4rem;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-select-sm {
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
        }

        .alert-info {
            background-color: rgba(13, 202, 240, 0.1);
            border-color: rgba(13, 202, 240, 0.3);
            color: #0dcaf0;
        }

        .badge {
            font-size: 0.7rem;
        }

        .modal-lg {
            max-width: 800px;
        }

        #studentDetailModal .table-sm td:first-child {
            width: 140px;
            font-weight: 500;
            color: #B0B3B8;
        }

        .pagination-sm .page-link {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }

    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/gastos">
                <img src="assets/images/Symbiot_logo_dark_horizon.png" alt="SYMBIOT Logo" style="height: 30px; margin-right: 8px;">
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard.html" style="color: #dc3545 !important; font-weight: bold;">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="gastos.html">
                            <i class="fas fa-money-bill-wave me-1"></i>Gastos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="event.preventDefault(); showComingSoon('Ingresos');">
                            <i class="fas fa-coins me-1"></i>Ingresos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="event.preventDefault(); showComingSoon('Reportes');">
                            <i class="fas fa-chart-bar me-1"></i>Reportes
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="userName">Usuario</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); showComingSoon('Perfil');"><i class="fas fa-user me-2"></i>Perfil</a></li>
                            <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); showComingSoon('Configuración');"><i class="fas fa-cog me-2"></i>Configuración</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); logout();"><i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesión</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid main-content">
        <!-- Welcome Banner -->
        <div class="welcome-banner" id="welcomeBanner">
            <h4 class="mb-1">¡Bienvenido, <span id="userNameDisplay">Usuario</span>!</h4>
            <p class="mb-0 text-muted">
                <i class="fas fa-building me-1"></i>
                <span id="userCompany">Cargando...</span> • 
                <span id="currentDate"></span>
            </p>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <!-- Balance Total -->
            <div class="col-sm-6 col-xl-3 mb-3">
                <div class="card stat-card h-100">
                    <div class="card-body d-flex align-items-center">
                        <i class="fas fa-wallet stat-icon text-info me-3"></i>
                        <div>
                            <h6 class="card-title">Balance Total</h6>
                            <h4 class="text-info mb-0" id="balanceTotal">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Ingresos -->
            <div class="col-sm-6 col-xl-3 mb-3">
                <div class="card stat-card h-100">
                    <div class="card-body d-flex align-items-center">
                        <i class="fas fa-arrow-up stat-icon text-success me-3"></i>
                        <div>
                            <h6 class="card-title">Total Ingresos</h6>
                            <h4 class="text-success mb-0" id="totalIngresos">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Gastos -->
            <div class="col-sm-6 col-xl-3 mb-3">
                <div class="card stat-card h-100">
                    <div class="card-body d-flex align-items-center">
                        <i class="fas fa-arrow-down stat-icon text-danger me-3"></i>
                        <div>
                            <h6 class="card-title">Total Gastos</h6>
                            <h4 class="text-danger mb-0" id="totalGastos">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </h4>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Este Mes -->
            <div class="col-sm-6 col-xl-3 mb-3">
                <div class="card stat-card h-100">
                    <div class="card-body d-flex align-items-center">
                        <i class="fas fa-calendar stat-icon text-warning me-3"></i>
                        <div>
                            <h6 class="card-title">Este Mes</h6>
                            <h4 class="text-warning mb-0" id="esteMes">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================= -->
        <!-- WIDGET SELECTOR DE EMPRESAS -->  
        <!-- Insertar DESPUÉS del Welcome Banner en dashboard.html -->
        <!-- ========================================= -->

        <!-- Company Selector Widget -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="text-white mb-0">
                            <i class="fas fa-building me-2"></i>Selector de Empresa
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <label for="companyFilter" class="form-label">
                                    <i class="fas fa-filter me-1"></i>Filtrar por Empresa
                                </label>
                                <select class="form-select" id="companyFilter" onchange="handleCompanyChange()">
                                    <option value="">🏢 Todas las Empresas</option>
                                    <option value="2">🔬 Symbiot Technologies</option>
                                    <option value="1">🎸 RockstarSkull Academia</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <div class="company-stats d-flex justify-content-around">
                                    <div class="stat-item text-center">
                                        <div class="stat-number text-info" id="companyTransactions">-</div>
                                        <div class="stat-label">Transacciones</div>
                                    </div>
                                    <div class="stat-item text-center" id="groupClassesIndicator" style="display: none;">
                                        <div class="stat-number text-primary" id="groupClasses">-</div>
                                        <div class="stat-label">Clases Grupales</div>
                                    </div>
                                    <div class="stat-item text-center" id="individualClassesIndicator" style="display: none;">
                                        <div class="stat-number text-success" id="individualClasses">-</div>
                                        <div class="stat-label">Clases Individuales</div>
                                    </div>
                                    <div class="stat-item text-center" id="currentStudentsIndicator" style="display: none;">
                                        <div class="stat-number text-warning" id="currentStudents">-</div>
                                        <div class="stat-label">Al Corriente</div>
                                    </div>
                                    <div class="stat-item text-center" id="pendingStudentsIndicator" style="display: none;">
                                        <div class="stat-number text-danger" id="pendingStudents">-</div>
                                        <div class="stat-label">Pendientes</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RockstarSkull Specific Widgets (Hidden by default) -->
        <div id="rockstarSkullWidgets" style="display: none;">
            <!-- Students Overview Widget -->
            <div class="row mb-4">
                <div class="col-xl-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="text-white mb-0">
                                <i class="fas fa-users me-2"></i>Alumnos Inscritos
                            </h6>
                            <span class="badge bg-primary" id="totalStudents" style="cursor: pointer;" onclick="filterStudentsByStatus('all')">0</span>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="student-stat" style="cursor: pointer;" onclick="filterStudentsByStatus('active')">
                                        <h4 class="text-success mb-1" id="activeStudents">0</h4>
                                        <small style="color: #E4E6EA !important;">Activos</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="student-stat" style="cursor: pointer;" onclick="filterStudentsByStatus('inactive')">
                                        <h4 class="text-danger mb-1" id="inactiveStudents">0</h4>
                                        <small style="color: #E4E6EA !important;">Bajas</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Classes Distribution -->
                            <div class="mt-3">
                                <small style="color: #E4E6EA !important;">Distribución por Clase:</small>
                                <div id="classDistribution" class="mt-2">
                                    <!-- Se llena dinámicamente con mejor diseño -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Teachers Overview Widget -->
                <div class="col-xl-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="text-white mb-0">
                                <i class="fas fa-chalkboard-teacher me-2"></i>Maestros Activos
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="teachersOverview">
                                <!-- Se llena dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Payment Alerts Widget -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="text-white mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>Alertas de Pagos
                            </h6>
                            <button class="btn btn-sm btn-outline-warning" onclick="refreshPaymentAlerts()">
                                <i class="fas fa-sync-alt me-1"></i>Actualizar
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="alert alert-warning" role="alert">
                                        <h6 class="alert-heading">
                                            <i class="fas fa-clock me-2"></i>Próximos a Vencer
                                        </h6>
                                        <div id="upcomingPayments">
                                            <small class="text-muted">Cargando...</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="alert alert-danger" role="alert">
                                        <h6 class="alert-heading">
                                            <i class="fas fa-exclamation-circle me-2"></i>Pagos Vencidos (+5 días)
                                        </h6>
                                        <div id="overduePayments">
                                            <small class="text-muted">Cargando...</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- ========================================= -->
            <!-- WIDGET SISTEMA DE GESTIÓN DE ALUMNOS -->
            <!-- Insertar DENTRO del div "rockstarSkullWidgets" -->
            <!-- DESPUÉS de las alertas de pagos -->
            <!-- ========================================= -->

            <!-- Students Management System -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="text-white mb-0">
                                <i class="fas fa-graduation-cap me-2"></i>Gestión de Alumnos - RockstarSkull
                            </h6>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-info" onclick="exportStudentsList()">
                                    <i class="fas fa-download me-1"></i>Exportar
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshStudentsList()">
                                    <i class="fas fa-sync-alt me-1"></i>Actualizar
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Filtros -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label">
                                        <i class="fas fa-filter me-1"></i>Filtrar por Maestro
                                    </label>
                                    <select class="form-select form-select-sm" id="teacherFilter" onchange="filterStudents()">
                                        <option value="">👨‍🏫 Todos los Maestros</option>
                                        <option value="Hugo Vázquez">🎸 Hugo Vázquez</option>
                                        <option value="Manuel Reyes">🎹 Manuel Reyes</option>
                                        <option value="Julio Olvera">🥁 Julio Olvera</option>
                                        <option value="Irwin">🎵 Irwin</option>
                                        <option value="Luis Blanquet">🎸 Luis Blanquet</option>
                                        <option value="Nahomy Perez">🎤 Nahomy Perez</option>
                                        <option value="Demian Andrade">🎸 Demian Andrade</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">
                                        <i class="fas fa-toggle-on me-1"></i>Estatus
                                    </label>
                                    <select class="form-select form-select-sm" id="statusFilter" onchange="filterStudents()">
                                        <option value="">📊 Todos los Estatus</option>
                                        <option value="Activo">✅ Activos</option>
                                        <option value="Baja">❌ Bajas</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">
                                        <i class="fas fa-music me-1"></i>Instrumento
                                    </label>
                                    <select class="form-select form-select-sm" id="instrumentFilter" onchange="filterStudents()">
                                        <option value="">🎼 Todos los Instrumentos</option>
                                        <option value="Guitarra">🎸 Guitarra</option>
                                        <option value="Teclado">🎹 Teclado</option>
                                        <option value="Batería">🥁 Batería</option>
                                        <option value="Bajo">🎸 Bajo</option>
                                        <option value="Canto">🎤 Canto</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">
                                        <i class="fas fa-calendar-exclamation me-1"></i>Pagos
                                    </label>
                                    <select class="form-select form-select-sm" id="paymentFilter" onchange="filterStudents()">
                                        <option value="">💰 Todos los Pagos</option>
                                        <option value="current">✅ Al Corriente</option>
                                        <option value="upcoming">⚠️ Próximos (3 días)</option>
                                        <option value="overdue">🚨 Vencidos (+5 días)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Summary Stats -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="alert alert-info d-flex justify-content-between align-items-center py-2">
                                        <div>
                                            <strong>Filtros Aplicados:</strong>
                                            <span id="filterSummary">Mostrando todos los alumnos</span>
                                        </div>
                                        <div>
                                            <span class="badge bg-primary" id="filteredCount">100</span> de 
                                            <span id="totalCount">100</span> alumnos
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Students Table -->
                            <div class="table-responsive">
                                <table class="table table-dark table-hover table-sm">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-hashtag me-1"></i>#</th>
                                            <th><i class="fas fa-user me-1"></i>Alumno</th>
                                            <th><i class="fas fa-birthday-cake me-1"></i>Edad</th>
                                            <th><i class="fas fa-music me-1"></i>Clase</th>
                                            <th><i class="fas fa-chalkboard-teacher me-1"></i>Maestro</th>
                                            <th><i class="fas fa-toggle-on me-1"></i>Estatus</th>
                                            <th><i class="fas fa-dollar-sign me-1"></i>Mensualidad</th>
                                            <th><i class="fas fa-calendar-day me-1"></i>Próximo Pago</th>
                                            <th><i class="fas fa-exclamation-triangle me-1"></i>Alerta</th>
                                            <th><i class="fas fa-cogs me-1"></i>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentsTableBody">
                                        <tr>
                                            <td colspan="10" class="text-center py-4">
                                                <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                                                <p class="mt-2 mb-0">Cargando lista de alumnos...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            <nav aria-label="Paginación de alumnos" class="mt-3">
                                <ul class="pagination pagination-sm justify-content-center" id="studentsPagination">
                                    <!-- Se genera dinámicamente -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        

        <!-- ========================================= -->
        <!-- MODAL DETALLE DE ALUMNO -->
        <!-- ========================================= -->
        <div class="modal fade" id="studentDetailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-user-graduate me-2"></i>
                            <span id="studentModalName">Detalle del Alumno</span>
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">📋 Información General</h6>
                                <table class="table table-dark table-sm">
                                    <tr><td><strong>Nombre:</strong></td><td id="modalStudentName">-</td></tr>
                                    <tr><td><strong>Edad:</strong></td><td id="modalStudentAge">-</td></tr>
                                    <tr><td><strong>Clase:</strong></td><td id="modalStudentClass">-</td></tr>
                                    <tr><td><strong>Maestro:</strong></td><td id="modalStudentTeacher">-</td></tr>
                                    <tr><td><strong>Horario:</strong></td><td id="modalStudentSchedule">-</td></tr>
                                    <tr><td><strong>Estatus:</strong></td><td id="modalStudentStatus">-</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success">💰 Información de Pagos</h6>
                                <table class="table table-dark table-sm">
                                    <tr><td><strong>Fecha Inscripción:</strong></td><td id="modalStudentEnrollment">-</td></tr>
                                    <tr><td><strong>Último Pago:</strong></td><td id="modalStudentLastPayment">-</td></tr>
                                    <tr><td><strong>Próximo Vence:</strong></td><td id="modalStudentNextDue">-</td></tr>
                                    <tr><td><strong>Mensualidad:</strong></td><td id="modalStudentMonthlyFee">-</td></tr>
                                    <tr><td><strong>Forma de Pago:</strong></td><td id="modalStudentPaymentMethod">-</td></tr>
                                    <tr><td><strong>Total Pagado:</strong></td><td id="modalStudentTotalPaid">-</td></tr>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Payment History Chart Placeholder -->
                        <div class="mt-3">
                            <h6 class="text-warning">📊 Historial de Pagos (Últimos 12 meses)</h6>
                            <div class="alert alert-secondary">
                                <i class="fas fa-chart-line me-2"></i>
                                Gráfico de historial de pagos - <em>Próximamente implementado</em>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-warning" onclick="markPaymentReceived()">
                            <i class="fas fa-money-bill me-1"></i>Registrar Pago
                        </button>
                        <button type="button" class="btn btn-info" onclick="sendPaymentReminder()">
                            <i class="fas fa-bell me-1"></i>Enviar Recordatorio
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Transactions -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="text-white mb-0">
                    <i class="fas fa-history me-2"></i>Transacciones Recientes
                </h5>
                <div>
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="refreshTransactions()">
                        <i class="fas fa-sync-alt me-1"></i>Actualizar
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="showAddTransactionModal()">
                        <i class="fas fa-plus me-1"></i>Nueva
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Loading State -->
                <div class="loading-spinner" id="transactionsLoading">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <p class="mt-2">Cargando transacciones...</p>
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>No hay transacciones registradas</p>
                    <button class="btn btn-outline-primary" onclick="showAddTransactionModal()">
                        <i class="fas fa-plus me-2"></i>Agregar Primera Transacción
                    </button>
                </div>

                <!-- Transactions Table -->
                <div class="table-responsive" id="transactionsTable" style="display: none;">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar-alt me-1"></i>Fecha</th>
                                <th><i class="fas fa-receipt me-1"></i>Concepto</th>
                                <th><i class="fas fa-user me-1"></i>Socio</th>
                                <th><i class="fas fa-building me-1"></i>Empresa</th>
                                <th><i class="fas fa-tags me-1"></i>Tipo</th>
                                <th><i class="fas fa-dollar-sign me-1"></i>Total</th>
                                <th><i class="fas fa-cogs me-1"></i>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody">
                            <!-- Se llenarán dinámicamente -->
                        </tbody>
                    </table>
                    
                    <!-- Pagination -->
                    <nav aria-label="Paginación de transacciones" class="mt-3">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Se generará dinámicamente -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- 🆕 MODAL NUEVA TRANSACCIÓN -->
    <div class="modal fade" id="addTransactionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus me-2"></i>Nueva Transacción
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addTransactionForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="transactionDate" class="form-label">
                                    <i class="fas fa-calendar me-1"></i>Fecha
                                </label>
                                <input type="date" class="form-control" id="transactionDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="transactionType" class="form-label">
                                    <i class="fas fa-tags me-1"></i>Tipo
                                </label>
                                <select class="form-select" id="transactionType" required>
                                    <option value="">Selecciona el tipo</option>
                                    <option value="I">💰 Ingreso</option>
                                    <option value="G">💸 Gasto</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="transactionConcept" class="form-label">
                                <i class="fas fa-receipt me-1"></i>Concepto
                            </label>
                            <input type="text" class="form-control" id="transactionConcept" 
                                   placeholder="Descripción de la transacción" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="transactionCompany" class="form-label">
                                    <i class="fas fa-building me-1"></i>Empresa
                                </label>
                                <select class="form-select" id="transactionCompany" required>
                                    <option value="">Cargando empresas...</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="transactionPayment" class="form-label">
                                    <i class="fas fa-credit-card me-1"></i>Forma de Pago
                                </label>
                                <select class="form-select" id="transactionPayment" required>
                                    <option value="">Selecciona forma de pago</option>
                                    <option value="Efectivo">💵 Efectivo</option>
                                    <option value="TDC">💳 Tarjeta de Crédito</option>
                                    <option value="Transferencia">🏦 Transferencia</option>
                                    <option value="TPV">📱 Terminal TPV</option>
                                    <option value="Cheque">📝 Cheque</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="transactionQuantity" class="form-label">
                                    <i class="fas fa-hashtag me-1"></i>Cantidad
                                </label>
                                <input type="number" class="form-control" id="transactionQuantity" 
                                       value="1" min="0.01" step="0.01" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="transactionPrice" class="form-label">
                                    <i class="fas fa-dollar-sign me-1"></i>Precio Unitario
                                </label>
                                <input type="number" class="form-control" id="transactionPrice" 
                                       min="0.01" step="0.01" placeholder="0.00" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="transactionTotal" class="form-label">
                                    <i class="fas fa-calculator me-1"></i>Total
                                </label>
                                <input type="text" class="form-control" id="transactionTotal" 
                                       placeholder="$0.00" readonly style="background-color: rgba(255,255,255,0.05);">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="submitTransaction()">
                        <i class="fas fa-save me-1"></i>Guardar Transacción
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 🌐 Variables globales
        let currentUser = null;
        let currentPage = 1;
        const transactionsPerPage = 10;

        // ✅ CORREGIDO: Asegurar que el modal esté disponible
        let addTransactionModalInstance = null;

        // 🚀 Inicialización al cargar la página
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Inicializando dashboard...');
            
            try {
                // Verificar sesión y obtener usuario
                await loadCurrentUser();
                
                // Cargar datos del dashboard
                await loadDashboardData();
                
                // Cargar transacciones recientes
                await loadRecentTransactions();
                
                // Establecer fecha actual
                updateCurrentDate();
                
                // Cargar empresas para el modal
                await loadCompaniesForModal();
                
                // ✅ CORREGIDO: Inicializar modal correctamente
                const modalElement = document.getElementById('addTransactionModal');
                if (modalElement) {
                    addTransactionModalInstance = new bootstrap.Modal(modalElement);
                    console.log('✅ Modal inicializado correctamente');
                }
                
                // ✅ CORREGIDO: Configurar listeners de cálculo
                setupCalculationListeners();
                
                // Configurar fecha por defecto en modal
                const today = new Date();
                const todayString = today.toISOString().split('T')[0];
                document.getElementById('transactionDate').value = todayString;
                
                console.log('✅ Dashboard cargado exitosamente');
                
            } catch (error) {
                console.error('❌ Error cargando dashboard:', error);
                showAlert('danger', 'Error cargando el dashboard. Redirigiendo al login...');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        });

        // ✅ CORREGIDO: Configurar listeners de cálculo automático
        function setupCalculationListeners() {
            const quantity = document.getElementById('transactionQuantity');
            const price = document.getElementById('transactionPrice');
            const total = document.getElementById('transactionTotal');
            
            function updateTotal() {
                const qty = parseFloat(quantity.value) || 0;
                const prc = parseFloat(price.value) || 0;
                const totalAmount = qty * prc;
                total.value = formatCurrency(totalAmount);
            }
            
            if (quantity && price && total) {
                quantity.addEventListener('input', updateTotal);
                price.addEventListener('input', updateTotal);
                console.log('✅ Listeners de cálculo configurados');
            }
        }

        // 👤 Cargar usuario actual
        async function loadCurrentUser() {
            try {
                console.log('👤 Cargando usuario actual...');
                
                const response = await fetch('/gastos/api/user');
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    document.getElementById('userName').textContent = currentUser.nombre;
                    document.getElementById('userNameDisplay').textContent = currentUser.nombre;
                    document.getElementById('userCompany').textContent = currentUser.empresa;
                    
                    console.log('✅ Usuario cargado:', currentUser.nombre);
                } else {
                    throw new Error('No hay sesión activa');
                }
                
            } catch (error) {
                console.error('❌ Error cargando usuario:', error);
                throw error;
            }
        }

        // 📊 Cargar datos del dashboard
        async function loadDashboardData() {
            try {
                console.log('📊 Cargando estadísticas del dashboard...');
                
                // Obtener resumen de transacciones
                const response = await fetch('/gastos/api/transacciones/resumen');
                const data = await response.json();
                
                if (data.success) {
                    const resumen = data.data;
                    
                    // Calcular totales
                    const totalIngresos = resumen.ingresos || 0;
                    const totalGastos = resumen.gastos || 0;
                    const balance = totalIngresos - totalGastos;
                    
                    // Actualizar interfaz
                    document.getElementById('totalIngresos').textContent = formatCurrency(totalIngresos);
                    document.getElementById('totalGastos').textContent = formatCurrency(totalGastos);
                    document.getElementById('balanceTotal').textContent = formatCurrency(balance);
                    
                    // Cambiar color del balance según si es positivo o negativo
                    const balanceElement = document.getElementById('balanceTotal');
                    if (balance >= 0) {
                        balanceElement.className = 'text-success mb-0';
                    } else {
                        balanceElement.className = 'text-danger mb-0';
                    }
                    
                    console.log('✅ Estadísticas cargadas - Balance:', formatCurrency(balance));
                } else {
                    console.warn('⚠️ No se pudieron cargar las estadísticas');
                    showNoDataStats();
                }
                
                // Cargar datos del mes actual
                await loadCurrentMonthData();
                
            } catch (error) {
                console.error('❌ Error cargando estadísticas:', error);
                showNoDataStats();
            }
        }

        // 📅 Cargar datos del mes actual
        async function loadCurrentMonthData() {
            try {
                const currentDate = new Date();
                const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                
                const fechaInicio = firstDay.toISOString().split('T')[0];
                const fechaFin = lastDay.toISOString().split('T')[0];
                
                const response = await fetch(`/gastos/api/transacciones/resumen?fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`);
                const data = await response.json();
                
                if (data.success) {
                    const resumen = data.data;
                    const balanceMes = (resumen.ingresos || 0) - (resumen.gastos || 0);
                    
                    document.getElementById('esteMes').textContent = formatCurrency(balanceMes);
                    
                    // Cambiar color según el balance del mes
                    const element = document.getElementById('esteMes');
                    if (balanceMes >= 0) {
                        element.className = 'text-success mb-0';
                    } else {
                        element.className = 'text-danger mb-0';
                    }
                }
            } catch (error) {
                console.error('❌ Error cargando datos del mes:', error);
                document.getElementById('esteMes').textContent = '$0.00';
            }
        }

        // 📋 Cargar transacciones recientes
        async function loadRecentTransactions(page = 1) {
            try {
                console.log(`📋 Cargando transacciones - Página ${page}...`);
                
                // Mostrar loading
                document.getElementById('transactionsLoading').style.display = 'block';
                document.getElementById('transactionsTable').style.display = 'none';
                document.getElementById('emptyState').style.display = 'none';
                
                const response = await fetch(`/gastos/api/transacciones?page=${page}&limit=${transactionsPerPage}`);
                const data = await response.json();
                
                if (data.success) {
                    const transactions = data.data;
                    
                    if (transactions && transactions.length > 0) {
                        renderTransactions(transactions);
                        renderPagination(data.pagination || {});
                        
                        document.getElementById('transactionsTable').style.display = 'block';
                        document.getElementById('emptyState').style.display = 'none';
                        
                        console.log(`✅ ${transactions.length} transacciones cargadas`);
                    } else {
                        document.getElementById('emptyState').style.display = 'block';
                        document.getElementById('transactionsTable').style.display = 'none';
                    }
                } else {
                    throw new Error(data.message || 'Error cargando transacciones');
                }
                
            } catch (error) {
                console.error('❌ Error cargando transacciones:', error);
                showAlert('danger', 'Error cargando las transacciones');
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('transactionsTable').style.display = 'none';
            } finally {
                document.getElementById('transactionsLoading').style.display = 'none';
            }
        }

        // 🎨 Renderizar transacciones en la tabla
        function renderTransactions(transactions) {
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = '';
            
            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'transaction-row';
                
                const tipoLabel = transaction.tipo === 'I' ? 'Ingreso' : 'Gasto';
                const tipoBadge = transaction.tipo === 'I' ? 'badge-success' : 'badge-danger';
                const tipoIcon = transaction.tipo === 'I' ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
                
                row.innerHTML = `
                    <td>${formatDate(transaction.fecha)}</td>
                    <td>${transaction.concepto}</td>
                    <td>${transaction.socio}</td>
                    <td>${transaction.nombre_empresa || 'N/A'}</td>
                    <td><span class="badge ${tipoBadge}"><i class="${tipoIcon} me-1"></i>${tipoLabel}</span></td>
                    <td class="${transaction.tipo === 'I' ? 'text-success' : 'text-danger'}">${formatCurrency(transaction.total)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editTransaction(${transaction.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction(${transaction.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // 📄 Renderizar paginación
        function renderPagination(pagination) {
            const paginationElement = document.getElementById('pagination');
            paginationElement.innerHTML = '';
            
            if (!pagination.totalPages || pagination.totalPages <= 1) return;
            
            // Botón anterior
            if (pagination.currentPage > 1) {
                paginationElement.innerHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="event.preventDefault(); loadRecentTransactions(${pagination.currentPage - 1})">Anterior</a>
                    </li>
                `;
            }
            
            // Páginas
            for (let i = 1; i <= pagination.totalPages; i++) {
                const isActive = i === pagination.currentPage ? 'active' : '';
                paginationElement.innerHTML += `
                    <li class="page-item ${isActive}">
                        <a class="page-link" href="#" onclick="event.preventDefault(); loadRecentTransactions(${i})">${i}</a>
                    </li>
                `;
            }
            
            // Botón siguiente
            if (pagination.currentPage < pagination.totalPages) {
                paginationElement.innerHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="event.preventDefault(); loadRecentTransactions(${pagination.currentPage + 1})">Siguiente</a>
                    </li>
                `;
            }
        }

        // 🏢 Cargar empresas para el modal
        async function loadCompaniesForModal() {
            try {
                const response = await fetch('/gastos/api/empresas');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('transactionCompany');
                    select.innerHTML = '<option value="">Selecciona empresa</option>';
                    
                    data.data.forEach(empresa => {
                        select.innerHTML += `<option value="${empresa.id}">${empresa.nombre}</option>`;
                    });
                    
                    console.log('✅ Empresas cargadas en modal');
                } else {
                    console.warn('⚠️ No se pudieron cargar empresas');
                }
            } catch (error) {
                console.error('❌ Error cargando empresas:', error);
            }
        }

        // ✅ CORREGIDO: Mostrar modal nueva transacción
        function showAddTransactionModal() {
            console.log('🆕 Abriendo modal nueva transacción...');
            
            try {
                // Limpiar formulario
                document.getElementById('addTransactionForm').reset();
                
                // Establecer fecha actual
                const today = new Date();
                const todayString = today.toISOString().split('T')[0];
                document.getElementById('transactionDate').value = todayString;
                
                // Limpiar total
                document.getElementById('transactionTotal').value = '$0.00';
                
                // Mostrar modal
                if (addTransactionModalInstance) {
                    addTransactionModalInstance.show();
                    console.log('✅ Modal abierto correctamente');
                } else {
                    // Fallback: crear modal dinámicamente
                    const modalElement = document.getElementById('addTransactionModal');
                    if (modalElement) {
                        addTransactionModalInstance = new bootstrap.Modal(modalElement);
                        addTransactionModalInstance.show();
                        console.log('✅ Modal creado y abierto');
                    } else {
                        throw new Error('Modal element not found');
                    }
                }
                
            } catch (error) {
                console.error('❌ Error abriendo modal:', error);
                showAlert('danger', 'Error abriendo el formulario de nueva transacción');
            }
        }

        // ✅ CORREGIDO: Enviar transacción
        async function submitTransaction() {
            console.log('💾 Enviando transacción...');
            
            try {
                const form = document.getElementById('addTransactionForm');
                
                // Validar formulario
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                // Recoger datos
                const transactionData = {
                    fecha: document.getElementById('transactionDate').value,
                    concepto: document.getElementById('transactionConcept').value,
                    empresa_id: parseInt(document.getElementById('transactionCompany').value),
                    forma_pago: document.getElementById('transactionPayment').value,
                    cantidad: parseFloat(document.getElementById('transactionQuantity').value),
                    precio_unitario: parseFloat(document.getElementById('transactionPrice').value),
                    tipo: document.getElementById('transactionType').value
                };
                
                console.log('📤 Datos a enviar:', transactionData);
                
                // Enviar al servidor
                const response = await fetch('/gastos/api/transacciones', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(transactionData)
                });
                
                const data = await response.json();
                console.log('📥 Respuesta del servidor:', data);
                
                if (data.success) {
                    // Cerrar modal
                    if (addTransactionModalInstance) {
                        addTransactionModalInstance.hide();
                    }
                    
                    // Mostrar éxito
                    const tipoTexto = transactionData.tipo === 'I' ? 'Ingreso' : 'Gasto';
                    showAlert('success', `${tipoTexto} registrado exitosamente: ${transactionData.concepto}`);
                    
                    // Recargar datos
                    console.log('🔄 Recargando dashboard...');
                    await loadDashboardData();
                    await loadRecentTransactions();
                    
                } else {
                    throw new Error(data.message || 'Error registrando transacción');
                }
                
            } catch (error) {
                console.error('❌ Error enviando transacción:', error);
                showAlert('danger', 'Error registrando la transacción: ' + error.message);
            }
        }

        // ✅ CORREGIDO: Cerrar sesión
        async function logout() {
            if (confirm('¿Está seguro que desea cerrar sesión?')) {
                try {
                    console.log('🚪 Cerrando sesión...');
                    
                    const response = await fetch('/gastos/api/logout', { 
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    });
                    
                    console.log('📤 Respuesta logout:', response.status);
                    
                    // Intentar obtener respuesta JSON
                    let data = null;
                    try {
                        data = await response.json();
                    } catch (parseError) {
                        console.log('⚠️ No se pudo parsear respuesta JSON');
                    }
                    
                    if (response.ok || response.status === 200) {
                        console.log('✅ Logout exitoso');
                        localStorage.removeItem('rememberedEmail');
                        window.location.href = 'login.html';
                    } else {
                        throw new Error('Error en logout del servidor');
                    }
                    
                } catch (error) {
                    console.error('❌ Error en logout:', error);
                    // Forzar redirección incluso si hay error
                    showAlert('warning', 'Cerrando sesión...');
                    localStorage.removeItem('rememberedEmail');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1000);
                }
            }
        }

        // ✅ CORREGIDO: Mostrar mensaje "Próximamente"
        function showComingSoon(feature) {
            console.log(`🚧 Función ${feature} próximamente...`);
            showAlert('info', `📋 ${feature} estará disponible en la próxima fase del desarrollo`);
        }

        // 🔄 Actualizar transacciones
        function refreshTransactions() {
            console.log('🔄 Actualizando transacciones...');
            loadRecentTransactions(currentPage);
        }

        // ✅ CORREGIDO: Placeholder functions con mensajes
        function editTransaction(id) {
            console.log(`✏️ Editando transacción ${id}...`);
            showAlert('info', `Editar transacción #${id} - Próximamente implementado`);
        }

        async function deleteTransaction(id) {
            console.log(`🗑️ Eliminando transacción ${id}...`);
            
            if (confirm('¿Está seguro de eliminar esta transacción?')) {
                try {
                    console.log(`🔥 Enviando DELETE para transacción ${id}...`);
                    
                    const response = await fetch(`/gastos/api/transacciones/${id}`, {
                        method: 'DELETE',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    console.log('📥 Respuesta DELETE:', data);
                    
                    if (data.success) {
                        showAlert('success', `Transacción eliminada exitosamente`);
                        
                        // Recargar datos
                        console.log('🔄 Recargando después de eliminar...');
                        await loadDashboardData();
                        await loadRecentTransactions();
                        
                    } else {
                        throw new Error(data.message || 'Error eliminando transacción');
                    }
                    
                } catch (error) {
                    console.error('❌ Error eliminando transacción:', error);
                    showAlert('danger', 'Error eliminando la transacción: ' + error.message);
                }
            }
        }

        // 🛠️ Funciones de utilidad
        function formatCurrency(amount) {
            if (amount == null || isNaN(amount)) return '$0.00';
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function updateCurrentDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('es-MX', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alert = document.createElement('div');
            alert.id = alertId;
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            alertContainer.appendChild(alert);
            
            // Auto-dismiss después de 5 segundos
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement && alertElement.parentNode) {
                    alertElement.remove();
                }
            }, 5000);
        }

        function showNoDataStats() {
            document.getElementById('totalIngresos').textContent = '$0.00';
            document.getElementById('totalGastos').textContent = '$0.00';
            document.getElementById('balanceTotal').textContent = '$0.00';
            document.getElementById('esteMes').textContent = '$0.00';
        }

        // 🔧 Log para debugging
        console.log('✅ Script dashboard cargado correctamente');
                
        // 🏢 Variables para filtro de empresa
        let currentCompanyFilter = '';
        let rockstarStudentsData = [];

        // 🔄 Manejar cambio de empresa
        async function handleCompanyChange() {
            const companySelect = document.getElementById('companyFilter');
            const selectedCompany = companySelect.value;
            currentCompanyFilter = selectedCompany;
            
            console.log(`🏢 Filtro de empresa cambiado a: ${selectedCompany || 'Todas'}`);
            
            try {
                // Recargar datos con filtro
                await loadDashboardData();
                await loadRecentTransactions(1);
                await loadCompanyStats(selectedCompany);
                
                // Mostrar/ocultar widgets específicos de RockstarSkull
                const rockstarWidgets = document.getElementById('rockstarSkullWidgets');
                if (selectedCompany === '1') { // RockstarSkull
                    rockstarWidgets.style.display = 'block';
                    await loadRockstarSkullData();
                    updateRockstarSkullIndicators();
                    loadStudentsList(); // ← ESTA LÍNEA DEBE EXISTIR
                }
                
            } catch (error) {
                console.error('❌ Error cambiando filtro de empresa:', error);
                showAlert('danger', 'Error aplicando filtro de empresa');
            }
        }

        // 📊 Cargar estadísticas específicas de empresa
        async function loadCompanyStats(companyId) {
            try {
                let queryParam = companyId ? `?empresa_id=${companyId}` : '';
                const response = await fetch(`/gastos/api/transacciones/resumen${queryParam}`);
                const data = await response.json();
                
                if (data.success) {
                    const resumen = data.data;
                    
                    // Actualizar stats del selector
                    document.getElementById('companyTransactions').textContent = resumen.total_transacciones || 0;
                    document.getElementById('companyIncome').textContent = formatCurrency(resumen.ingresos || 0);
                    document.getElementById('companyExpenses').textContent = formatCurrency(resumen.gastos || 0);
                    document.getElementById('companyBalance').textContent = formatCurrency(resumen.balance || 0);
                    
                    // Cambiar color del balance
                    const balanceElement = document.getElementById('companyBalance');
                    if ((resumen.balance || 0) >= 0) {
                        balanceElement.className = 'stat-number text-success';
                    } else {
                        balanceElement.className = 'stat-number text-danger';
                    }
                }
            } catch (error) {
                console.error('❌ Error cargando stats de empresa:', error);
            }
        }

        // 🎸 Cargar datos específicos de RockstarSkull
        async function loadRockstarSkullData() {
            try {
                console.log('🎸 Cargando datos específicos de RockstarSkull...');
                
                // Aquí cargaríamos los datos de alumnos desde una nueva API
                // Por ahora simulamos los datos basados en el análisis del Excel
                
                // Estadísticas de alumnos (simuladas basadas en el análisis)
                const studentStats = {
                    total: 100,
                    activos: 35, // Aproximación basada en el análisis
                    bajas: 65
                };
                
                // Actualizar widgets
                document.getElementById('totalStudents').textContent = studentStats.total;
                document.getElementById('activeStudents').textContent = studentStats.activos;
                document.getElementById('inactiveStudents').textContent = studentStats.bajas;
                
                // Distribución por clases (simulada)
                const classDistribution = [
                    { clase: 'Guitarra Eléctrica', alumnos: 45, color: 'danger', icon: 'fas fa-guitar' },
                    { clase: 'Teclado/Piano', alumnos: 20, color: 'success', icon: 'fas fa-piano-keyboard' },
                    { clase: 'Batería', alumnos: 15, color: 'warning', icon: 'fas fa-drum-steelpan' },
                    { clase: 'Bajo Eléctrico', alumnos: 12, color: 'info', icon: 'fas fa-guitar' },
                    { clase: 'Canto/Vocal', alumnos: 8, color: 'secondary', icon: 'fas fa-microphone-alt' }
                ];

                const classDistributionHTML = `
                    <div class="row g-2">
                        ${classDistribution.map(item => `
                            <div class="col">
                                <div class="instrument-card text-center p-2 rounded" style="background: rgba(255,255,255,0.05);">
                                    <i class="fas ${item.icon} fa-2x text-${item.color} mb-2"></i>
                                    <div class="fw-bold" style="color: #E4E6EA;">${item.alumnos}</div>
                                    <small style="color: #B8B9BA;">${item.clase}</small>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                document.getElementById('classDistribution').innerHTML = classDistributionHTML;
                
                // Overview de maestros (simulado)
                const teachersData = [
                    { nombre: 'Hugo Vázquez', alumnos: 35, ingresos: 52500 },
                    { nombre: 'Manuel Reyes', alumnos: 20, ingresos: 30000 },
                    { nombre: 'Julio Olvera', alumnos: 18, ingresos: 27000 },
                    { nombre: 'Irwin', alumnos: 15, ingresos: 22500 },
                    { nombre: 'Luis Blanquet', alumnos: 8, ingresos: 12000 },
                    { nombre: 'Nahomy Perez', alumnos: 4, ingresos: 6000 }
                ];
                
                const teachersHTML = teachersData.map(teacher => `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded" style="background: rgba(255,255,255,0.05);">
                        <div>
                            <strong style="color: #E4E6EA;">${teacher.nombre}</strong><br>
                            <small style="color: #B8B9BA;">${teacher.alumnos} alumnos</small>
                        </div>
                        <div class="text-end">
                            <div class="text-success">${formatCurrency(teacher.ingresos)}</div>
                        </div>
                    </div>
                `).join('');
                
                document.getElementById('teachersOverview').innerHTML = teachersHTML;
                
                // Alertas de pagos (placeholder por ahora)
                document.getElementById('upcomingPayments').innerHTML = `
                    <small class="text-muted">📅 Próximamente: Sistema de alertas de pagos basado en fechas de inscripción</small>
                `;
                
                document.getElementById('overduePayments').innerHTML = `
                    <small class="text-muted">⚠️ Próximamente: Detección automática de pagos vencidos (+5 días)</small>
                `;

                await refreshPaymentAlerts();
                
                console.log('✅ Datos de RockstarSkull cargados');
                
            } catch (error) {
                console.error('❌ Error cargando datos de RockstarSkull:', error);
            }
        }

        // 🔄 Actualizar alertas de pagos
        async function refreshPaymentAlerts() {
            try {
                console.log('🔄 Actualizando alertas de pagos...');
                
                const response = await fetch('/gastos/api/alertas-pagos');
                const data = await response.json();
                
                if (data.success) {
                    const { proximos_vencer, vencidos } = data.data;
                    
                    // Actualizar próximos a vencer
                    const proximosHTML = proximos_vencer.length > 0 
                        ? proximos_vencer.map(alumno => `
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small><strong>${alumno.nombre}</strong> - ${alumno.clase}</small>
                                <small class="text-warning">${alumno.dias_restantes} días</small>
                            </div>
                        `).join('')
                        : '<small class="text-muted">✅ No hay pagos próximos a vencer</small>';
                    
                    // Actualizar vencidos
                    const vencidosHTML = vencidos.length > 0 
                        ? vencidos.map(alumno => `
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small><strong>${alumno.nombre}</strong> - ${alumno.clase}</small>
                                <small class="text-danger">🚨 ${alumno.dias_vencido} días</small>
                            </div>
                        `).join('')
                        : '<small class="text-muted">✅ No hay pagos vencidos</small>';
                    
                    // Actualizar elementos HTML existentes
                    document.getElementById('upcomingPayments').innerHTML = proximosHTML;
                    document.getElementById('overduePayments').innerHTML = vencidosHTML;
                    
                    showAlert('success', `✅ Alertas actualizadas: ${data.data.total_alertas} alertas activas`);
                    
                } else {
                    throw new Error(data.error || 'Error obteniendo alertas');
                }
                
            } catch (error) {
                console.error('❌ Error actualizando alertas:', error);
                showAlert('error', 'Error actualizando alertas de pagos');
                
                // Fallback a mensajes estáticos
                document.getElementById('upcomingPayments').innerHTML = 
                    '<small class="text-muted">⚠️ Error cargando alertas próximas</small>';
                document.getElementById('overduePayments').innerHTML = 
                    '<small class="text-muted">⚠️ Error cargando alertas vencidas</small>';
            }
        }

        // 🎓 Función loadStudentsList() - NUEVA IMPLEMENTACIÓN
        async function loadStudentsList() {
            try {
                console.log('🎓 Cargando lista de alumnos...');
                
                // Por ahora simulamos datos basados en el análisis del Excel RockstarSkull
                const studentsData = [
                    { 
                        id: 1, nombre: 'Juan Pérez', edad: 16, clase: 'Guitarra', maestro: 'Hugo Vázquez',
                        estatus: 'Activo', precioMensual: 1500, fechaInscripcion: '2024-01-15',
                        fechaUltimoPago: '2025-01-15', formaPago: 'Efectivo', totalPagado: 18000
                    },
                    { 
                        id: 2, nombre: 'María García', edad: 22, clase: 'Piano', maestro: 'Manuel Reyes',
                        estatus: 'Activo', precioMensual: 1200, fechaInscripcion: '2024-02-10',
                        fechaUltimoPago: '2025-01-10', formaPago: 'Transferencia', totalPagado: 14400
                    },
                    { 
                        id: 3, nombre: 'Carlos López', edad: 19, clase: 'Batería', maestro: 'Julio Olvera',
                        estatus: 'Baja', precioMensual: 1800, fechaInscripcion: '2023-08-20',
                        fechaUltimoPago: '2024-12-20', formaPago: 'TPV', totalPagado: 25200
                    },
                    { 
                        id: 4, nombre: 'Ana Martínez', edad: 17, clase: 'Canto', maestro: 'Nahomy Perez',
                        estatus: 'Activo', precioMensual: 1000, fechaInscripcion: '2024-03-05',
                        fechaUltimoPago: '2024-12-05', formaPago: 'Efectivo', totalPagado: 10000
                    },
                    { 
                        id: 5, nombre: 'Luis Rivera', edad: 25, clase: 'Bajo', maestro: 'Luis Blanquet',
                        estatus: 'Baja', precioMensual: 1300, fechaInscripcion: '2023-11-12',
                        fechaUltimoPago: '2024-11-12', formaPago: 'Transferencia', totalPagado: 15600
                    }
                ];
                
                // Almacenar datos globalmente para otras funciones
                window.rockstarStudentsData = studentsData;
                
                // Actualizar contadores en los widgets
                const activeStudents = studentsData.filter(s => s.estatus === 'Activo').length;
                const inactiveStudents = studentsData.filter(s => s.estatus === 'Baja').length;
                
                document.getElementById('totalStudents').textContent = studentsData.length;
                document.getElementById('activeStudents').textContent = activeStudents;
                document.getElementById('inactiveStudents').textContent = inactiveStudents;
                
                // Renderizar tabla de alumnos (si existe el elemento)
                const tableBody = document.getElementById('studentsTableBody');
                if (tableBody) {
                    renderStudentsTable(studentsData);
                }
                
                console.log(`✅ Lista de alumnos cargada: ${studentsData.length} estudiantes`);
                
            } catch (error) {
                console.error('❌ Error cargando lista de alumnos:', error);
                showAlert('error', 'Error cargando lista de alumnos');
            }
        }

        // 🎓 Función auxiliar para renderizar tabla de alumnos
        function renderStudentsTable(students) {
            const tableBody = document.getElementById('studentsTableBody');
            if (!tableBody) return;
            
            const html = students.map((student, index) => {
                const statusBadge = student.estatus === 'Activo' 
                    ? '<span class="badge bg-success">✅ Activo</span>'
                    : '<span class="badge bg-danger">❌ Baja</span>';
                
                return `
                    <tr class="student-row" onclick="showStudentDetail(${student.id})">
                        <td>${index + 1}</td>
                        <td><strong>${student.nombre}</strong><br><small class="text-muted">#${student.id}</small></td>
                        <td>${student.edad}</td>
                        <td>${getInstrumentIcon(student.clase)} ${student.clase}</td>
                        <td>${student.maestro}</td>
                        <td>${statusBadge}</td>
                        <td class="text-success">${formatCurrency(student.precioMensual)}</td>
                        <td>${formatDate(student.fechaUltimoPago)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showStudentDetail(${student.id})" title="Ver Detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tableBody.innerHTML = html;
        }

        // 🎓 Función auxiliar para iconos de instrumentos
        function getInstrumentIcon(instrument) {
            const icons = {
                'Guitarra': '🎸',
                'Piano': '🎹', 
                'Teclado': '🎹',
                'Batería': '🥁',
                'Bajo': '🎸',
                'Canto': '🎤'
            };
            return icons[instrument] || '🎵';
        }

        // ✅ ACTUALIZACIÓN: Modificar funciones existentes para usar filtro

        // Modificar loadDashboardData para incluir filtro de empresa
        async function loadDashboardDataWithFilter() {
            try {
                console.log('📊 Cargando estadísticas con filtro de empresa...');
                
                // Construir query con filtro si existe
                let queryParam = '';
                if (currentCompanyFilter) {
                    queryParam = `?empresa_id=${currentCompanyFilter}`;
                }
                
                // Obtener resumen de transacciones
                const response = await fetch(`/gastos/api/transacciones/resumen${queryParam}`);
                const data = await response.json();
                
                if (data.success) {
                    const resumen = data.data;
                    
                    // Calcular totales
                    const totalIngresos = resumen.ingresos || 0;
                    const totalGastos = resumen.gastos || 0;
                    const balance = totalIngresos - totalGastos;
                    
                    // Actualizar interfaz principal
                    document.getElementById('totalIngresos').textContent = formatCurrency(totalIngresos);
                    document.getElementById('totalGastos').textContent = formatCurrency(totalGastos);
                    document.getElementById('balanceTotal').textContent = formatCurrency(balance);
                    
                    // Cambiar color del balance según si es positivo o negativo
                    const balanceElement = document.getElementById('balanceTotal');
                    if (balance >= 0) {
                        balanceElement.className = 'text-success mb-0';
                    } else {
                        balanceElement.className = 'text-danger mb-0';
                    }
                    
                    console.log('✅ Estadísticas cargadas con filtro - Balance:', formatCurrency(balance));
                } else {
                    console.warn('⚠️ No se pudieron cargar las estadísticas');
                    showNoDataStats();
                }
                
                // Cargar datos del mes actual con filtro
                await loadCurrentMonthDataWithFilter();
                
            } catch (error) {
                console.error('❌ Error cargando estadísticas:', error);
                showNoDataStats();
            }
        }

        // Modificar loadCurrentMonthData para incluir filtro
        async function loadCurrentMonthDataWithFilter() {
            try {
                const currentDate = new Date();
                const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                
                const fechaInicio = firstDay.toISOString().split('T')[0];
                const fechaFin = lastDay.toISOString().split('T')[0];
                
                let queryParam = `?fechaInicio=${fechaInicio}&fechaFin=${fechaFin}`;
                if (currentCompanyFilter) {
                    queryParam += `&empresa_id=${currentCompanyFilter}`;
                }
                
                const response = await fetch(`/gastos/api/transacciones/resumen${queryParam}`);
                const data = await response.json();
                
                if (data.success) {
                    const resumen = data.data;
                    const balanceMes = (resumen.ingresos || 0) - (resumen.gastos || 0);
                    
                    document.getElementById('esteMes').textContent = formatCurrency(balanceMes);
                    
                    // Cambiar color según el balance del mes
                    const element = document.getElementById('esteMes');
                    if (balanceMes >= 0) {
                        element.className = 'text-success mb-0';
                    } else {
                        element.className = 'text-danger mb-0';
                    }
                }
            } catch (error) {
                console.error('❌ Error cargando datos del mes:', error);
                document.getElementById('esteMes').textContent = '$0.00';
            }
        }

        // Modificar loadRecentTransactions para incluir filtro
        async function loadRecentTransactionsWithFilter(page = 1) {
            try {
                console.log(`📋 Cargando transacciones con filtro - Página ${page}...`);
                
                // Construir query con filtro
                let queryParam = `?page=${page}&limit=${transactionsPerPage}`;
                if (currentCompanyFilter) {
                    queryParam += `&empresa_id=${currentCompanyFilter}`;
                }
                
                // Mostrar loading
                document.getElementById('transactionsLoading').style.display = 'block';
                document.getElementById('transactionsTable').style.display = 'none';
                document.getElementById('emptyState').style.display = 'none';
                
                const response = await fetch(`/gastos/api/transacciones${queryParam}`);
                const data = await response.json();
                
                if (data.success) {
                    const transactions = data.data;
                    
                    if (transactions && transactions.length > 0) {
                        renderTransactions(transactions);
                        renderPagination(data.pagination || {});
                        
                        document.getElementById('transactionsTable').style.display = 'block';
                        document.getElementById('emptyState').style.display = 'none';
                        
                        console.log(`✅ ${transactions.length} transacciones cargadas con filtro`);
                    } else {
                        document.getElementById('emptyState').style.display = 'block';
                        document.getElementById('transactionsTable').style.display = 'none';
                    }
                } else {
                    throw new Error(data.message || 'Error cargando transacciones');
                }
                
            } catch (error) {
                console.error('❌ Error cargando transacciones:', error);
                showAlert('danger', 'Error cargando las transacciones');
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('transactionsTable').style.display = 'none';
            } finally {
                document.getElementById('transactionsLoading').style.display = 'none';
            }
        }

        // ✅ ACTUALIZAR: Reemplazar las funciones originales
        window.loadDashboardData = loadDashboardDataWithFilter;
        window.loadCurrentMonthData = loadCurrentMonthDataWithFilter;
        window.loadRecentTransactions = loadRecentTransactionsWithFilter;

        console.log('✅ Selector de empresas configurado');

        // 🎯 CAMBIO 6: Variables para filtros interactivos
        let currentStudentFilter = 'all'; // 'all', 'active', 'inactive'
        /*let studentsData = {
            all: [],
            active: [],
            inactive: []
        };*/

        // 🎯 CAMBIO 7: Función para filtrar alumnos por estatus
        // ✅ VERSIÓN ACTUALIZADA
        function filterStudentsByStatus(status) {
            console.log(`👥 Filtrando alumnos por: ${status}`);
            
            // Contar alumnos según estatus desde studentsData real
            const activeCount = studentsData.filter(s => s.estatus === 'Activo').length;
            const inactiveCount = studentsData.filter(s => s.estatus === 'Baja').length;
            const totalCount = studentsData.length;
            
            const counts = {
                'active': { total: activeCount, title: 'Alumnos Activos' },
                'inactive': { total: inactiveCount, title: 'Alumnos con Baja' },  
                'all': { total: totalCount, title: 'Todos los Alumnos' }
            };
            
            const info = counts[status] || counts['all'];
            showAlert('info', `📊 Mostrando: ${info.title} (${info.total} estudiantes)`);
            
            // Actualizar distribución
            updateClassDistribution(status);
        }

        // 🎯 CAMBIO 8: Actualizar distribución de clases según filtro
        function updateClassDistribution(filterStatus) {
            const classData = {
                'all': [
                    { clase: 'Guitarra', alumnos: 45, activos: 18, inactivos: 27 },
                    { clase: 'Teclado', alumnos: 20, activos: 8, inactivos: 12 },
                    { clase: 'Batería', alumnos: 15, activos: 5, inactivos: 10 },
                    { clase: 'Bajo', alumnos: 12, activos: 3, inactivos: 9 },
                    { clase: 'Canto', alumnos: 8, activos: 1, inactivos: 7 }
                ]
            };
            
            // Ejemplo de cómo podrían ser tus funciones getClassColor y getClassIcon
            const getClassColor = (clase) => {
                const colors = {
                    'Guitarra': 'primary', 'Teclado': 'success', 'Batería': 'warning', 'Bajo': 'info', 'Canto': 'secondary'
                };
                return colors[clase];
            };
            
            const getClassIcon = (clase) => {
                const icons = {
                    'Guitarra': 'fa-solid fa-electric-guitar', 'Teclado': 'fa-solid fa-piano', 'Batería': 'fa-solid fa-drum', 'Bajo': 'fa-solid fa-electric-guitar', 'Canto': 'fa-solid fa-microphone'
                };
                return icons[clase];
            };
            
            const classDistribution = classData.all.map(item => ({
                ...item,
                color: getClassColor(item.clase),
                icon: getClassIcon(item.clase),
                displayCount: filterStatus === 'active' ? item.activos : 
                    filterStatus === 'inactive' ? item.inactivos : item.alumnos
            }));
            
            const classDistributionHTML = `
                <div class="row g-2">
                    ${classDistribution.map(item => `
                        <div class="col">
                            <div class="instrument-card text-center p-2 rounded" style="background: rgba(255,255,255,0.05);">
                                <i class="${item.icon} fa-2x text-${item.color} mb-2"></i>
                                <div class="fw-bold" style="color: #E4E6EA;">${item.displayCount}</div>
                                <small style="color: #B8B9BA;">${item.clase}</small>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('classDistribution').innerHTML = classDistributionHTML;
        }

        // 🎯 CAMBIO 9: Actualizar indicadores del selector para RockstarSkull
        function updateRockstarSkullIndicators() {
            // Mostrar indicadores específicos de academia
            document.getElementById('groupClassesIndicator').style.display = 'block';
            document.getElementById('individualClassesIndicator').style.display = 'block'; 
            document.getElementById('currentStudentsIndicator').style.display = 'block';
            document.getElementById('pendingStudentsIndicator').style.display = 'block';
            
            // Datos simulados basados en análisis
            document.getElementById('groupClasses').textContent = '15';
            document.getElementById('individualClasses').textContent = '85';
            document.getElementById('currentStudents').textContent = '35';
            document.getElementById('pendingStudents').textContent = '12';
        }

        // 🎯 CAMBIO 10: Ocultar indicadores específicos para otras empresas  
        function hideRockstarSkullIndicators() {
            document.getElementById('groupClassesIndicator').style.display = 'none';
            document.getElementById('individualClassesIndicator').style.display = 'none';
            document.getElementById('currentStudentsIndicator').style.display = 'none'; 
            document.getElementById('pendingStudentsIndicator').style.display = 'none';
        }

        // 🎯 CAMBIO 11: Funciones utilitarias
        function getStudentCountByStatus(status) {
            const counts = { active: 35, inactive: 65, all: 100 };
            return counts[status] || 0;
        }

        function getClassColor(clase) {
            const colors = {
                'Guitarra': 'primary',
                'Teclado': 'success', 
                'Batería': 'warning',
                'Bajo': 'info',
                'Canto': 'secondary'
            };
            return colors[clase] || 'primary';
        }

        function getClassIcon(clase) {
            const icons = {
                'Guitarra': 'fas fa-guitar', // Guitarra eléctrica
                'Teclado': 'fas fa-piano-keyboard', // Teclado/Piano
                'Batería': 'fas fa-drum-steelpan', // Batería más específica
                'Bajo': 'fas fa-guitar', // Bajo eléctrico (mismo icono pero diferente color)
                'Canto': 'fas fa-microphone-alt' // Micrófono más moderno
            };
            return icons[clase] || 'fas fa-music';
        }

        // ✅ CORRECCIÓN: Agregar async a la función
        async function handleCompanyChange() {
            const companySelect = document.getElementById('companyFilter');
            const selectedCompany = companySelect.value;
            currentCompanyFilter = selectedCompany;
            
            console.log(`🏢 Filtro de empresa cambiado a: ${selectedCompany || 'Todas'}`);
            
            try {
                await loadDashboardData();
                await loadRecentTransactions(1);
                await loadCompanyStats(selectedCompany);
                
                const rockstarWidgets = document.getElementById('rockstarSkullWidgets');
                if (selectedCompany === '1') { 
                    rockstarWidgets.style.display = 'block';
                    await loadRockstarSkullData();
                    updateRockstarSkullIndicators();
                    loadStudentsList(); // ← AGREGAR ESTA LÍNEA
                } else {
                    rockstarWidgets.style.display = 'none';
                    hideRockstarSkullIndicators();
                }
                
            } catch (error) {
                console.error('❌ Error cambiando filtro de empresa:', error);
                showAlert('danger', 'Error aplicando filtro de empresa');
            }
        }
        // 📊 Cargar estadísticas específicas de empresa
        async function loadCompanyStats(companyId) {
            try {
                let queryParam = companyId ? `?empresa_id=${companyId}` : '';
                const response = await fetch(`/gastos/api/transacciones/resumen${queryParam}`);
                const data = await response.json();
                
                if (data.success) {
                    const resumen = data.data;
                    
                    // Actualizar stats del selector
                    document.getElementById('companyTransactions').textContent = resumen.total_transacciones || 0;
                    
                    // Solo mostrar ingresos/gastos/balance si NO es RockstarSkull
                    if (companyId !== '1') {
                        document.getElementById('companyIncome').textContent = formatCurrency(resumen.ingresos || 0);
                        document.getElementById('companyExpenses').textContent = formatCurrency(resumen.gastos || 0);
                        document.getElementById('companyBalance').textContent = formatCurrency(resumen.balance || 0);
                    }
                }
            } catch (error) {
                console.error('❌ Error cargando stats de empresa:', error);
            }
        }
        // 🎓 Variables para gestión de alumnos
        let studentsData = [];
        let filteredStudents = [];
        let currentStudentPage = 1;
        const studentsPerPage = 15;

        // 🎓 Datos simulados basados en análisis del Excel (muestra representativa)
        const sampleStudentsData = [
            {
                id: 1,
                nombre: "Gwyneth Adriana Tagliabue Cruz",
                edad: 15,
                maestro: "Hugo Vázquez", 
                fechaInscripcion: new Date("2023-08-01"),
                fechaUltimoPago: new Date("2023-11-01"),
                clase: "Guitarra",
                tipo: "G",
                horario: "19:00 a 20:00 V",
                formaPago: "TPV",
                precioMensual: 1500,
                estatus: "Baja",
                totalPagado: 5550
            },
            {
                id: 2,
                nombre: "Alejandro Navarro Baltazar",
                edad: 36,
                maestro: "Hugo Vázquez",
                fechaInscripcion: new Date("2023-08-02"),
                fechaUltimoPago: new Date("2023-09-01"),
                clase: "Guitarra",
                tipo: "G", 
                horario: "17:00 a 18:00 Mi",
                formaPago: "Efectivo",
                precioMensual: 1500,
                estatus: "Baja",
                totalPagado: 3000
            },
            {
                id: 3,
                nombre: "Manuel Zacate Millan",
                edad: 62,
                maestro: "Hugo Vázquez",
                fechaInscripcion: new Date("2023-08-03"),
                fechaUltimoPago: new Date("2023-09-01"),
                clase: "Guitarra", 
                tipo: "G",
                horario: "18:00 a 19:00 J",
                formaPago: "Efectivo",
                precioMensual: 1400,
                estatus: "Baja",
                totalPagado: 2900
            },
            {
                id: 4,
                nombre: "Luis Erik Arias Ayala",
                edad: 11,
                maestro: "Manuel Reyes",
                fechaInscripcion: new Date("2023-09-01"),
                fechaUltimoPago: new Date("2025-07-01"),
                clase: "Teclado",
                tipo: "T",
                horario: "16:00 a 17:00 S",
                formaPago: "Transferencia",
                precioMensual: 1500,
                estatus: "Activo",
                totalPagado: 36600
            },
            {
                id: 5,
                nombre: "Jose Fernando Campos Esparza",
                edad: 28,
                maestro: "Hugo Vázquez",
                fechaInscripcion: new Date("2023-09-01"),
                fechaUltimoPago: new Date("2023-09-01"),
                clase: "Guitarra",
                tipo: "G",
                horario: "20:00 a 21:00 V",
                formaPago: "Efectivo",
                precioMensual: 2000,
                estatus: "Baja", 
                totalPagado: 2000
            },
            // Agregar más alumnos activos para demostrar alertas
            {
                id: 6,
                nombre: "María González López",
                edad: 25,
                maestro: "Julio Olvera",
                fechaInscripcion: new Date("2024-01-15"),
                fechaUltimoPago: new Date("2025-08-15"),
                clase: "Batería",
                tipo: "B",
                horario: "18:00 a 19:00 L",
                formaPago: "TPV",
                precioMensual: 1800,
                estatus: "Activo",
                totalPagado: 14400
            },
            {
                id: 7,
                nombre: "Carlos Mendoza Ruiz",
                edad: 17,
                maestro: "Luis Blanquet", 
                fechaInscripcion: new Date("2024-06-10"),
                fechaUltimoPago: new Date("2025-08-10"),
                clase: "Bajo",
                tipo: "B",
                horario: "17:00 a 18:00 Ma",
                formaPago: "Transferencia",
                precioMensual: 1600,
                estatus: "Activo",
                totalPagado: 8000
            },
            {
                id: 8,
                nombre: "Ana Sofía Hernández",
                edad: 22,
                maestro: "Nahomy Perez",
                fechaInscripcion: new Date("2025-03-20"),
                fechaUltimoPago: new Date("2025-08-14"), // Próximo a vencer
                clase: "Canto",
                tipo: "C",
                horario: "19:00 a 20:00 Mi",
                formaPago: "TPV",
                precioMensual: 1700,
                estatus: "Activo",
                totalPagado: 8500
            }
        ];

        // 🎓 Cargar lista de alumnos (actualizar cuando tengamos API real)
        function loadStudentsList() {
            console.log('🎓 Cargando lista de alumnos...');
            
            // Por ahora usar datos simulados, después conectar a API
            studentsData = sampleStudentsData;
            filteredStudents = [...studentsData];
            
            renderStudentsTable();
            updateStudentsPagination();
            updateFilterSummary();
            
            console.log(`✅ ${studentsData.length} alumnos cargados`);
        }

        // 🎓 Filtrar alumnos por criterios
        function filterStudents() {
            const teacherFilter = document.getElementById('teacherFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const instrumentFilter = document.getElementById('instrumentFilter').value;
            const paymentFilter = document.getElementById('paymentFilter').value;
            
            console.log('🔍 Aplicando filtros:', { teacherFilter, statusFilter, instrumentFilter, paymentFilter });
            
            filteredStudents = studentsData.filter(student => {
                // Filtro por maestro
                if (teacherFilter && student.maestro !== teacherFilter) return false;
                
                // Filtro por estatus  
                if (statusFilter && student.estatus !== statusFilter) return false;
                
                // Filtro por instrumento
                if (instrumentFilter && student.clase !== instrumentFilter) return false;
                
                // Filtro por estado de pagos
                if (paymentFilter) {
                    const paymentStatus = getPaymentStatus(student);
                    if (paymentFilter !== paymentStatus) return false;
                }
                
                return true;
            });
            
            currentStudentPage = 1;
            renderStudentsTable();
            updateStudentsPagination(); 
            updateFilterSummary();
        }

        // 🎓 Determinar estado de pago del alumno
        function getPaymentStatus(student) {
            if (student.estatus === 'Baja') return 'inactive';
            
            const today = new Date();
            const nextDueDate = getNextPaymentDate(student);
            const daysDiff = Math.ceil((nextDueDate - today) / (1000 * 60 * 60 * 24));
            
            if (daysDiff < -5) return 'overdue';  // Vencido +5 días
            if (daysDiff <= 3 && daysDiff >= 0) return 'upcoming'; // Próximo (3 días)
            return 'current'; // Al corriente
        }

        // 🎓 Calcular próxima fecha de pago basada en fecha de inscripción
        function getNextPaymentDate(student) {
            const inscriptionDate = new Date(student.fechaInscripcion);
            const dayOfMonth = inscriptionDate.getDate();
            
            const today = new Date();
            let nextPayment = new Date(today.getFullYear(), today.getMonth(), dayOfMonth);
            
            // Si ya pasó este mes, calcular para el próximo
            if (nextPayment < today) {
                nextPayment.setMonth(nextPayment.getMonth() + 1);
            }
            
            return nextPayment;
        }

        // 🎓 Renderizar tabla de alumnos
        function renderStudentsTable() {
            const tbody = document.getElementById('studentsTableBody');
            
            if (filteredStudents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-4">
                            <i class="fas fa-search fa-2x text-muted"></i>
                            <p class="mt-2 mb-0 text-muted">No se encontraron alumnos con los filtros aplicados</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const startIndex = (currentStudentPage - 1) * studentsPerPage;
            const endIndex = Math.min(startIndex + studentsPerPage, filteredStudents.length);
            const pageStudents = filteredStudents.slice(startIndex, endIndex);
            
            tbody.innerHTML = pageStudents.map((student, index) => {
                const paymentStatus = getPaymentStatus(student);
                const nextPaymentDate = getNextPaymentDate(student);
                
                const alertBadge = getPaymentAlertBadge(paymentStatus);
                const statusBadge = student.estatus === 'Activo' 
                    ? '<span class="badge bg-success">✅ Activo</span>'
                    : '<span class="badge bg-danger">❌ Baja</span>';
                    
                return `
                    <tr class="student-row" onclick="showStudentDetail(${student.id})">
                        <td>${startIndex + index + 1}</td>
                        <td>
                            <strong>${student.nombre}</strong><br>
                            <small class="text-muted">#${student.id}</small>
                        </td>
                        <td>${student.edad}</td>
                        <td>
                            ${getInstrumentIcon(student.clase)} ${student.clase}
                        </td>
                        <td>${student.maestro}</td>
                        <td>${statusBadge}</td>
                        <td class="text-success">${formatCurrency(student.precioMensual)}</td>
                        <td>${formatDate(nextPaymentDate)}</td>
                        <td>${alertBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showStudentDetail(${student.id})" title="Ver Detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 🎓 Obtener badge de alerta de pago
        function getPaymentAlertBadge(status) {
            switch (status) {
                case 'overdue':
                    return '<span class="badge bg-danger">🚨 Vencido</span>';
                case 'upcoming':
                    return '<span class="badge bg-warning">⚠️ Próximo</span>';
                case 'current':
                    return '<span class="badge bg-success">✅ Al día</span>';
                default:
                    return '<span class="badge bg-secondary">-</span>';
            }
        }

        // 🎓 Obtener icono del instrumento
        function getInstrumentIcon(instrument) {
            const icons = {
                'Guitarra': '🎸',
                'Teclado': '🎹',
                'Batería': '🥁',
                'Bajo': '🎸',
                'Canto': '🎤'
            };
            return icons[instrument] || '🎵';
        }

        // 🎓 Actualizar paginación
        function updateStudentsPagination() {
            const totalPages = Math.ceil(filteredStudents.length / studentsPerPage);
            const pagination = document.getElementById('studentsPagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Página anterior
            if (currentStudentPage > 1) {
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="event.preventDefault(); changeStudentPage(${currentStudentPage - 1})">Anterior</a>
                    </li>
                `;
            }
            
            // Páginas numeradas
            for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                const isActive = i === currentStudentPage ? 'active' : '';
                paginationHTML += `
                    <li class="page-item ${isActive}">
                        <a class="page-link" href="#" onclick="event.preventDefault(); changeStudentPage(${i})">${i}</a>
                    </li>
                `;
            }
            
            // Página siguiente
            if (currentStudentPage < totalPages) {
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="event.preventDefault(); changeStudentPage(${currentStudentPage + 1})">Siguiente</a>
                    </li>
                `;
            }
            
            pagination.innerHTML = paginationHTML;
        }

        // 🎓 Cambiar página de alumnos
        function changeStudentPage(page) {
            currentStudentPage = page;
            renderStudentsTable();
            updateStudentsPagination();
        }

        // 🎓 Actualizar resumen de filtros
        function updateFilterSummary() {
            const total = studentsData.length;
            const filtered = filteredStudents.length;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('filteredCount').textContent = filtered;
            
            // Construir descripción de filtros
            const filters = [];
            const teacherFilter = document.getElementById('teacherFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const instrumentFilter = document.getElementById('instrumentFilter').value;
            const paymentFilter = document.getElementById('paymentFilter').value;
            
            if (teacherFilter) filters.push(`Maestro: ${teacherFilter}`);
            if (statusFilter) filters.push(`Estatus: ${statusFilter}`);
            if (instrumentFilter) filters.push(`Instrumento: ${instrumentFilter}`);
            if (paymentFilter) filters.push(`Pagos: ${getPaymentFilterLabel(paymentFilter)}`);
            
            const summary = filters.length > 0 
                ? `Filtros activos: ${filters.join(', ')}`
                : 'Mostrando todos los alumnos';
                
            document.getElementById('filterSummary').textContent = summary;
        }

        // 🎓 Obtener etiqueta del filtro de pagos
        function getPaymentFilterLabel(filter) {
            const labels = {
                'current': 'Al Corriente',
                'upcoming': 'Próximos a Vencer',
                'overdue': 'Vencidos'
            };
            return labels[filter] || filter;
        }

        // 🎓 Mostrar detalle del alumno
        function showStudentDetail(studentId) {
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;
            
            console.log('👁️ Mostrando detalle del alumno:', student.nombre);
            
            // Llenar modal con datos
            document.getElementById('studentModalName').textContent = student.nombre;
            document.getElementById('modalStudentName').textContent = student.nombre;
            document.getElementById('modalStudentAge').textContent = student.edad;
            document.getElementById('modalStudentClass').textContent = student.clase;
            document.getElementById('modalStudentTeacher').textContent = student.maestro;
            document.getElementById('modalStudentSchedule').textContent = student.horario;
            document.getElementById('modalStudentStatus').innerHTML = student.estatus === 'Activo' 
                ? '<span class="badge bg-success">✅ Activo</span>'
                : '<span class="badge bg-danger">❌ Baja</span>';
            
            document.getElementById('modalStudentEnrollment').textContent = formatDate(student.fechaInscripcion);
            document.getElementById('modalStudentLastPayment').textContent = formatDate(student.fechaUltimoPago);
            document.getElementById('modalStudentNextDue').textContent = formatDate(getNextPaymentDate(student));
            document.getElementById('modalStudentMonthlyFee').textContent = formatCurrency(student.precioMensual);
            document.getElementById('modalStudentPaymentMethod').textContent = student.formaPago;
            document.getElementById('modalStudentTotalPaid').textContent = formatCurrency(student.totalPagado);
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('studentDetailModal'));
            modal.show();
        }

        // 🎓 Funciones de acciones
        function refreshStudentsList() {
            console.log('🔄 Actualizando lista de alumnos...');
            showAlert('info', 'Lista de alumnos actualizada');
            loadStudentsList();
        }

        function exportStudentsList() {
            console.log('💾 Exportando lista de alumnos...');
            showAlert('info', 'Funcionalidad de exportación - Próximamente implementada');
        }

        function markPaymentReceived() {
            showAlert('info', 'Registro de pago recibido - Próximamente implementado');
        }

        function sendPaymentReminder() {
            showAlert('info', 'Envío de recordatorio de pago - Próximamente implementado');
        }

        // 🎓 Auto-inicializar cuando se muestre RockstarSkull
        /*const originalLoadRockstarSkullData = window.loadRockstarSkullData;
        window.loadRockstarSkullData = async function() {
            await originalLoadRockstarSkullData();
            loadStudentsList();
        };*/

        // Auto-cargar cuando se inicialice
        document.addEventListener('DOMContentLoaded', function() {
            // Si RockstarSkull ya está seleccionado, cargar alumnos
            setTimeout(() => {
                const companySelect = document.getElementById('companyFilter');
                if (companySelect && companySelect.value === '1') {
                    loadStudentsList();
                }
            }, 2000);
        });

        console.log('✅ Sistema de gestión de alumnos configurado');
    </script>
</body>
</html>